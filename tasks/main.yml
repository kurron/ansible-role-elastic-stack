---
- name: Install Elasticsearch Key
  become: yes
  apt_key:
      url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
      state: present
  when: (ansible_distribution == "Ubuntu")

- name: Install Elasticsearch Repository
  become: yes
  apt_repository:
      repo: "deb https://artifacts.elastic.co/packages/{{ elastic_stack_version }}/apt stable main"
      state: present
  when: (ansible_distribution == "Ubuntu")

- name: Install Elasticsearch
  become: yes
  apt:
      name: elasticsearch
      update_cache: yes
      state: present
      allow_unauthenticated: yes
  when: (ansible_distribution == "Ubuntu") and (elastic_elasticsearch_install)

- name: Adjust Elasticsearch Configuration
  become: yes
  lineinfile:
      dest: /etc/default/elasticsearch
      line: "JAVA_HOME={{ jdk_global_jdk_directory }}"
  when: (ansible_distribution == "Ubuntu") and (elastic_elasticsearch_install)

- name: Enable Elasticsearch
  become: yes
  shell: systemctl daemon-reload && systemctl enable elasticsearch.service
  when: elastic_elasticsearch_install

- name: Start Elasticsearch
  become: yes
  command: systemctl restart elasticsearch.service
  when: elastic_elasticsearch_install

# not working for some reason
- name: Test Elasticsearch
  become: no
  command: "curl -XGET 'localhost:9200/?pretty'"
  when: false

- name: Install Kibana
  become: yes
  apt:
      name: kibana
      update_cache: yes
      state: present
      allow_unauthenticated: yes
  when: (ansible_distribution == "Ubuntu") and (elastic_kibana_install)

- name: Enable Kibana
  become: yes
  shell: systemctl daemon-reload && systemctl enable kibana.service
  when: elastic_kibana_install

- name: Start Kibana
  become: yes
  command: systemctl restart kibana.service
  when: elastic_kibana_install

- name: Install Logstash
  become: yes
  apt:
      name: logstash
      update_cache: yes
      state: present
      allow_unauthenticated: yes
  when: (ansible_distribution == "Ubuntu") and (elastic_logstash_install)
